@startuml Sharded File Server - Download Sequence

actor Client
participant "Sharded File Server" as Server
database "Shard Storage" as Storage
database "Backup Storage" as Backup
database "Metadata Storage" as Meta

== Download Request ==

Client -> Server: GET /file\n(uniqueId + password)

== Metadata & Key Derivation ==

Server -> Meta: Load Merkle Tree metadata\n(by uniqueId)
Server -> Server: Derive encryption key\n(from password + uniqueId)
Server -> Server: Derive seed\n(from password + uniqueId)

== Sharded File Load ==

loop for each sharded file (1..16)
  Server -> Server: Derive storage path\n(from seed + index)
  Server -> Storage: Load sharded file
end

== Hashing & Integrity Verification ==

Server -> Server: Generate Merkle Tree\n(from sharded file hashes)
Server -> Server: Compare generated Merkle Root\nwith stored Merkle Root

alt Merkle Root mismatch
  Server -> Server: Traverse Merkle Tree\n(to locate corrupted sharded files)

  loop for each corrupted sharded file
    Server -> Backup: Load sharded file (recovery)
    Server -> Server: Replace corrupted sharded file
  end
end

== File Reassembly ==

Server -> Server: Reassemble sharded files
Server -> Server: Decrypt file\n(using derived key)
Server -> Client: Return original file

@enduml
